<!--
# Copyright (c) Jupyter Development Team.
# Distributed under the terms of the Modified BSD License.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../urth-core-dataframe/urth-core-dataframe.html">
<link rel="import" href="../urth-core-dataframe/urth-core-query-filter.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../iron-icon/iron-icon.html">

<!--
This element represents a query executed against an urth-core-dataframe element.

Example:
@group Urth Viz
@element urth-viz-query
-->

<dom-module id="urth-viz-query">
    <style>
        .querior > h3 {
            font-variant: small-caps;
        }
        .query-rule {
            display: flex;
            flex-flow: row nowrap;
            justify-content: space-between;
        }
        .query-rule > :not(paper-button) {
            margin-left: 0.3em;
            margin-right: 0.3em;
        }
        .query-rule > paper-button {
            min-width: initial;
            align-items: flex-end;
            color: #737373;
        }
        .query-rule > paper-button[disabled] {
            visibility: hidden;
        }
    </style>

  <template>
      <div class="querior">
          <h3>Match <em>all</em> of the following rules:</h3>
          <template is="dom-repeat" items="{{rules}}" as="rule">
              <div class="query-rule">
                  <paper-dropdown-menu label="column" selected-item-label="{{rule.col}}">
                      <paper-listbox class="dropdown-content">
                          <template is="dom-repeat" items="{{columns}}">
                              <paper-item>{{item}}</paper-item>
                          </template>
                      </paper-listbox>
                  </paper-dropdown-menu>
                  <paper-dropdown-menu>
                      <paper-listbox class="dropdown-content" selected="{{rule.op}}" attr-for-selected="value">
                          <paper-item value="==">equals</paper-item>
                          <paper-item value="!=">does not equal</paper-item>
                          <!-- <paper-item>contains</paper-item>
                          <paper-item>does not contain</paper-item> -->
                      </paper-listbox>
                  </paper-dropdown-menu>
                  <paper-input label="value" value="{{rule.val}}"></paper-input>
                  <paper-button on-tap="deleteRule">
                      <iron-icon icon="icons:delete"></iron-icon>
                  </paper-button>
              </div>
          </template>
          <paper-button on-tap="addRule">
              <iron-icon icon="icons:add-circle-outline"></iron-icon>
              Add filter
          </paper-button>

          <!-- repeating query-filter elements to be stamped as children of myDataframe -->
          <template id="filters" is="dom-repeat" items="{{rules}}" as="rule" filter="hasValue" observe="col op val">
              <urth-core-query-filter disabled="[[!rule.val]]">{{ruleExpression(rule.col, rule.op, rule.val)}}</urth-core-query-filter>
          </template>

          <!-- user declares dataframe here -->
          <content id="myDataframe" select="urth-core-dataframe"></content>
      </div>
  </template>
</dom-module>
<script>
(function(){
    'use strict';

    window.Urth = window.Urth || {};

    window.Urth['urth-viz-query'] = Polymer({
        is: 'urth-viz-query',

        properties: {
            // n-element array with shape to fit query form
            rules: {
                type: Array,
                value: function() { return [{ col: null, op: null, val: null }]; }
            }
        },

        ruleExpression: function(col, op, val) {
            if (Number.isNaN(+val)) {
                val = "'" + val + "'";
            }
            return col + ' ' + op + ' ' + val;
        },

        hasValue: function(rule) {
            return rule.val !== null && rule.val !== '';
        },

        addRule: function(event) {
            this.push('rules', { col: null, op: null, val: null });
        },

        deleteRule: function(event) {
            this.splice('rules', event.model.index, 1);
        },

        ready: function() {
            // move filters template to user-supplied urth-core-dataframe in light DOM
            var df = this.$.myDataframe.getDistributedNodes()[0];
            df.appendChild(this.$.filters.root);

            this.columns = df.columns;
            df.addEventListener('columns-changed', function(event) {
                this.columns = df.columns;
            }.bind(this));
        }
    });
})();
</script>
