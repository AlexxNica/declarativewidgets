<!--
# Copyright (c) Jupyter Development Team.
# Distributed under the terms of the Modified BSD License.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../urth-core-dataframe/urth-core-dataframe.html">
<link rel="import" href="../urth-core-dataframe/urth-core-query-filter.html">
<link rel="import" href="../urth-viz-table/urth-viz-table.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../iron-icon/iron-icon.html">

<!--
This element represents a query executed against an urth-core-dataframe element.

Example:
@group Urth Viz
@element urth-viz-query
-->

<dom-module id="urth-viz-query">
    <style>
        .querior > h3 {
            font-variant: small-caps;
        }
        .querior > urth-viz-table {
            margin-top: 1em;
            display: block;
        }
        .query-rule {
            display: flex;
            flex-flow: row nowrap;
            justify-content: space-between;
        }
        .query-rule.enabled-false {
            display: none;
        }
        .query-rule > :not(paper-button) {
            margin-left: 0.3em;
            margin-right: 0.3em;
        }
        .query-rule > paper-button {
            min-width: initial;
            align-items: flex-end;
            color: #737373;
        }
        .query-rule > paper-button[disabled] {
            visibility: hidden;
        }
    </style>
â€‹
  <template>
    <div class="querior">
        <h3>Match <em>all</em> of the following rules:</h3>
<template is="dom-repeat" items="{{rules}}" as="rule">
        <div class="query-rule">
            <paper-dropdown-menu label="column" selected-item-label="{{rule.col}}">
                <paper-listbox class="dropdown-content">
                    <template is="dom-repeat" items="{{df.columns}}">
                        <paper-item>{{item}}</paper-item>
                    </template>
                </paper-listbox>
            </paper-dropdown-menu>
            <paper-dropdown-menu>
                <paper-listbox class="dropdown-content" selected="{{rule.op}}" attr-for-selected="value">
                    <paper-item value="==">equals</paper-item>
                    <paper-item value="!=">does not equal</paper-item>
                    <!-- <paper-item>contains</paper-item>
                    <paper-item>does not contain</paper-item> -->
                </paper-listbox>
            </paper-dropdown-menu>
            <paper-input label="value" value="{{rule.val}}"></paper-input>
            <paper-button disabled="[[!rule.val]]" toggles active="{{toggle1}}">
                <iron-icon icon="icons:add-circle-outline"></iron-icon>
            </paper-button>
        </div>
</template>
<!--
        <div class$="query-rule enabled-{{toggle1}}">
            <paper-dropdown-menu label="column" selected-item-label="{{col2}}">
                <paper-listbox class="dropdown-content">
                    <template is="dom-repeat" items="{{df.columns}}">
                        <paper-item>{{item}}</paper-item>
                    </template>
                </paper-listbox>
            </paper-dropdown-menu>
            <paper-dropdown-menu>
                <paper-listbox class="dropdown-content" selected="{{op2}}" attr-for-selected="value">
                    <paper-item value="==">equals</paper-item>
                    <paper-item value="!=">does not equal</paper-item>
                    <!- <paper-item>contains</paper-item>
                    <paper-item>does not contain</paper-item> ->
                </paper-listbox>
            </paper-dropdown-menu>
            <paper-input label="value" value="{{val2}}"></paper-input>
            <paper-button disabled="[[!val2]]" toggles active="{{toggle2}}">
                <iron-icon icon="icons:add-circle-outline"></iron-icon>
            </paper-button>
        </div>
-->
        <urth-core-dataframe id="df1" ref="{{dataframe}}" value="{{df}}" limit="20">
            <template is="dom-repeat" items="{{rules}}" as="rule" filter="hasValue" observe="val">
                <urth-core-query-filter disabled="[[!rule.val]]">{{ruleExpression(rule.col, rule.op, rule.val)}}</urth-core-query-filter>
            </template>
        </urth-core-dataframe>
        <h3>Results:</h3>
        <urth-viz-table datarows="{{df.data}}" columns="{{df.columns}}"></urth-viz-table>
    </div>
  </template>
</dom-module>
<script>
(function(){
    'use strict';

    window.Urth = window.Urth || {};

    window.Urth['urth-viz-query'] = Polymer({
        is: 'urth-viz-query',

        properties: {
            dataframe: String,

            // n-element array with shape to fit query form
            rules: {
                type: Array,
                value: function() { return [null, null, null].map(function(){ return { col: null, op: null, val: null }; }); } }
        },

        ruleExpression: function(col, op, val) {
            if (Number.isNaN(+val)) {
                val = "'" + val + "'";
            }
            return col + ' ' + op + ' ' + val;
        },

        hasValue: function(rule) {
            return rule.val !== null && rule.val !== '';
        },
    });
})();
</script>
