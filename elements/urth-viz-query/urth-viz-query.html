<!--
# Copyright (c) Jupyter Development Team.
# Distributed under the terms of the Modified BSD License.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../urth-core-dataframe/urth-core-dataframe.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../iron-icon/iron-icon.html">

<!--
This element represents a query executed against an urth-core-dataframe element.

Example:
@group Urth Viz
@element urth-viz-query
-->

<dom-module id="urth-viz-query">
    <style>
        .querior > h3 {
            font-variant: small-caps;
        }
        .query-rule {
            display: flex;
            flex-flow: row nowrap;
            justify-content: space-between;
        }
        .query-rule > :not(paper-button) {
            margin-left: 0.3em;
            margin-right: 0.3em;
        }
        .query-rule > paper-button {
            min-width: initial;
            align-items: flex-end;
            color: #737373;
        }
        .query-rule > paper-button[disabled] {
            visibility: hidden;
        }
    </style>

  <template>
      <template is="dom-if" if="[[!groups.length]]">
          <paper-button on-tap="addGroup">
              <iron-icon icon="icons:add-circle-outline"></iron-icon>
              Add group-by
          </paper-button>
      </template>

      <template is="dom-repeat" items="{{groups}}" as="group">
          <div>
              <span>Group by:</span>
              <paper-dropdown-menu label="column" selected-item-label="{{group.col}}">
                  <paper-listbox class="dropdown-content">
                      <template is="dom-repeat" items="{{originalColumns}}">
                          <paper-item>{{item}}</paper-item>
                      </template>
                  </paper-listbox>
              </paper-dropdown-menu>
              <paper-button on-tap="deleteGroup">
                  <iron-icon icon="icons:delete"></iron-icon>
              </paper-button>

              <div style="margin-left: 50px;">
                  <template is="dom-repeat" items="{{group.aggregators}}" as="agg">
                    <div>
                      <paper-dropdown-menu label="operation" selected-item-label="{{agg.op}}" on-iron-select="_contentChanged">
                          <paper-listbox class="dropdown-content">
                              <paper-item>sum</paper-item>
                              <paper-item>mean</paper-item>
                          </paper-listbox>
                      </paper-dropdown-menu>

                      <paper-dropdown-menu label="column" selected-item-label="{{agg.col}}" on-iron-select="_contentChanged">
                          <paper-listbox class="dropdown-content">
                              <template is="dom-repeat" items="{{originalColumns}}">
                                  <paper-item>{{item}}</paper-item>
                              </template>
                          </paper-listbox>
                      </paper-dropdown-menu>

                      <paper-button on-tap="deleteAgg">
                          <iron-icon icon="icons:delete"></iron-icon>
                      </paper-button>
                    </div>
                  </template>

                  <div>
                      <paper-button on-tap="addAgg">
                          <iron-icon icon="icons:add-circle-outline"></iron-icon>
                          Add aggregate function
                      </paper-button>
                  </div>
              </div>
          </div>
      </template>
      <div class="querior">
          <h3>Match <em>all</em> of the following rules:</h3>
          <template is="dom-repeat" items="{{rules}}" as="rule">
              <div class="query-rule">
                  <paper-dropdown-menu label="column" selected-item-label="{{rule.col}}">
                      <paper-listbox class="dropdown-content">
                          <template is="dom-repeat" items="{{originalColumns}}">
                              <paper-item>{{item}}</paper-item>
                          </template>
                      </paper-listbox>
                  </paper-dropdown-menu>
                  <paper-dropdown-menu>
                      <paper-listbox class="dropdown-content" selected="{{rule.op}}" attr-for-selected="value">
                          <paper-item value="==">equals</paper-item>
                          <paper-item value="!=">does not equal</paper-item>
                          <!-- <paper-item>contains</paper-item>
                          <paper-item>does not contain</paper-item> -->
                      </paper-listbox>
                  </paper-dropdown-menu>
                  <paper-input label="value" value="{{rule.val}}"></paper-input>
                  <paper-button on-tap="deleteRule">
                      <iron-icon icon="icons:delete"></iron-icon>
                  </paper-button>
              </div>
          </template>
          <div>
              <paper-button on-tap="addRule">
                  <iron-icon icon="icons:add-circle-outline"></iron-icon>
                  Add filter
              </paper-button>
          </div>

          <!-- repeating query-group elements to be stamped as children of myDataframe -->
          <template id="groups" is="dom-repeat" items="{{groups}}" as="group">
              <urth-core-query-group by$="{{group.col}}" disabled="[[!group.col]]">
                  <template is="dom-repeat" items="{{group.aggregators}}" as="agg" observe="col op">
                      <urth-core-query-agg op$="{{agg.op}}" col$="{{agg.col}}" disabled="[[!agg.col]]"></urth-core-query-agg>
                  </template>
              </urth-core-query-group>
          </template>

          <!-- repeating query-filter elements to be stamped as children of myDataframe -->
          <template id="filters" is="dom-repeat" items="{{rules}}" as="rule" filter="hasValue" observe="col op val">
              <urth-core-query-filter disabled="[[!rule.val]]">{{ruleExpression(rule.col, rule.op, rule.val)}}</urth-core-query-filter>
          </template>

          <!-- user declares dataframe here -->
          <content id="myDataframe" select="urth-core-dataframe"></content>
      </div>
  </template>
</dom-module>
<script>
(function(){
    'use strict';

    window.Urth = window.Urth || {};

    window.Urth['urth-viz-query'] = Polymer({
        is: 'urth-viz-query',

        properties: {
            // n-element array with shape to fit query form
            rules: {
                type: Array,
                value: function() { return [{ col: null, op: null, val: null }]; }
            },

            groups: {
                type: Array,
                value: function() { return [{ col: null, aggregators: [] }]; }
            }
        },

        ruleExpression: function(col, op, val) {
            if (Number.isNaN(+val)) {
                val = "'" + val + "'";
            }
            return col + ' ' + op + ' ' + val;
        },

        hasValue: function(rule) {
            return rule.val !== null && rule.val !== '';
        },

        addRule: function(event) {
            this.push('rules', { col: null, op: null, val: null });
        },

        addGroup: function(event) {
            this.push('groups', { col: null, aggregators: [] });
        },

        addAgg: function(event) {
            this.push('groups.0.aggregators', { op: null, col: null });
        },

        deleteRule: function(event) {
            this.splice('rules', event.model.index, 1);
        },

        deleteGroup: function(event) {
            this.splice('groups', event.model.index, 1);
        },

        deleteAgg: function(event) {
            this.splice('groups.0.aggregators', event.model.index, 1);
        },

_contentChanged: function(event) {
    this.querySelector('urth-core-query-group')._contentChanged(); // HACK. urth-core-group-agg property changes should trigger a change in the query group
},

        ready: function() {
            // move filters template to user-supplied urth-core-dataframe in light DOM
            var dataframe = this.$.myDataframe.getDistributedNodes()[0];
            dataframe.appendChild(this.$.filters.root);
            dataframe.appendChild(this.$.groups.root);

            this.columns = dataframe.columns;

            // Keep track of dataframe columns prior to group operation
            this.originalColumns = this.columns;

            dataframe.addEventListener('columns-changed', function(event) {
                this.columns = dataframe.columns;

                if (!this.groups || !this.groups.length || !this.groups[0].col) {
                    // Only update if this is not a group operation
                    this.originalColumns = this.columns;
                }
            }.bind(this));
        }
    });
})();
</script>
